import streamlit as st
from datetime import datetime
import pandas as pd
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
import logging
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import time

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© - BASIC CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
st.set_page_config(page_title="ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ù…Ø§Ø³ØªØ±", page_icon="ğŸ“", layout="centered")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø· - STYLES & CSS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

st.markdown("""
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
html, body, [class*="css"] { font-family: 'Cairo', sans-serif !important; }
.main { background-color: #0A1B2C; color: #ffffff; }
.block-container { padding: 2rem; background-color: #1A2A3D; border-radius: 12px; max-width: 750px; margin:auto;}
label, h1, h2, h3, h4, h5, h6, p, span, .stTextInput label { color:#ffffff !important; }
button { background-color:#256D85 !important; color:white !important; border:none !important; padding:10px 20px !important; border-radius:6px !important; }
button:hover { background-color:#2C89A0 !important; }
.success-msg, .error-msg, .info-msg { color: #FFFFFF; padding: 15px; margin: 10px 0; }
.stat-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0; }
</style>
""", unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Sheets - GOOGLE SHEETS CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
info = st.secrets["service_account"]
credentials = Credentials.from_service_account_info(info, scopes=SCOPES)
sheets_service = build('sheets', 'v4', credentials=credentials)

STUDENTS_SHEET_ID = "1gvNkOVVKo6AO07dRKMnSQw6vZ3KdUnW7I4HBk61Sqns"
MEMOS_SHEET_ID = "1LNJMBAye4QIQy7JHz6F8mQ6-XNC1weZx1ozDZFfjD5s"
PROF_MEMOS_SHEET_ID = "1OnZi1o-oPMUI_W_Ew-op0a1uOhSj006hw_2jrMD6FSE"

STUDENTS_RANGE = "Feuille 1!A1:L1000"
MEMOS_RANGE = "Feuille 1!A1:N1000"
PROF_MEMOS_RANGE = "Feuille 1!A1:L1000"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - EMAIL CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EMAIL_SENDER = "domaine.dsp@univ-bba.dz"
EMAIL_PASSWORD = "oevruyiztgikwzah"
SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. Ø§Ù„Ø«ÙˆØ§Ø¨Øª - CONSTANTS (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USER_TYPE_STUDENT = "student"
USER_TYPE_PROFESSOR = "professor"
USER_TYPE_ADMIN = "admin"
MEMO_REGISTERED = "Ù†Ø¹Ù…"
ADMIN_USERNAME = "admin"  # ØºÙŠÙ‘Ø± Ù‡Ù†Ø§
ADMIN_PASSWORD = "admin2026"  # ØºÙŠÙ‘Ø± Ù‡Ù†Ø§

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© - UTILITY FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def col_letter(n):
    result = ""
    while n > 0:
        n, remainder = divmod(n - 1, 26)
        result = chr(65 + remainder) + result
    return result

def sanitize_input(text):
    if not text:
        return ""
    dangerous_chars = ['<', '>', '"', "'", ';', '&', '|', '`']
    cleaned = str(text).strip()
    for char in dangerous_chars:
        cleaned = cleaned.replace(char, '')
    return cleaned

def validate_username(username):
    username = sanitize_input(username)
    if not username:
        return False, "âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ§Ø±Øº"
    return True, username

def validate_note_number(note_number):
    note_number = sanitize_input(note_number)
    if not note_number:
        return False, "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø© ÙØ§Ø±Øº"
    if len(note_number) > 20:
        return False, "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­"
    return True, note_number

def clear_cache_and_reload():
    st.cache_data.clear()
    logger.info("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - DATA LOADING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@st.cache_data(ttl=60)
def load_students():
    try:
        result = sheets_service.spreadsheets().values().get(spreadsheetId=STUDENTS_SHEET_ID, range=STUDENTS_RANGE).execute()
        values = result.get('values', [])
        if not values:
            return pd.DataFrame()
        return pd.DataFrame(values[1:], columns=values[0])
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨: {e}")
        return pd.DataFrame()

@st.cache_data(ttl=60)
def load_memos():
    try:
        result = sheets_service.spreadsheets().values().get(spreadsheetId=MEMOS_SHEET_ID, range=MEMOS_RANGE).execute()
        values = result.get('values', [])
        if not values:
            return pd.DataFrame()
        return pd.DataFrame(values[1:], columns=values[0])
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª: {e}")
        return pd.DataFrame()

@st.cache_data(ttl=60)
def load_prof_memos():
    try:
        result = sheets_service.spreadsheets().values().get(spreadsheetId=PROF_MEMOS_SHEET_ID, range=PROF_MEMOS_RANGE).execute()
        values = result.get('values', [])
        if not values:
            return pd.DataFrame()
        return pd.DataFrame(values[1:], columns=values[0])
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©: {e}")
        return pd.DataFrame()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 8. Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - EMAIL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def send_email_to_professor(prof_email, prof_name, memo_info, student1, student2=None):
    try:
        df_prof_memos = load_prof_memos()
        prof_memos = df_prof_memos[df_prof_memos["Ø§Ù„Ø£Ø³ØªØ§Ø°"].astype(str).str.strip() == prof_name.strip()]
        total = len(prof_memos)
        registered = len(prof_memos[prof_memos["ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„"].astype(str).str.strip() == MEMO_REGISTERED])
        
        student2_info = f"\nğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: {student2['Ø§Ù„Ù„Ù‚Ø¨']} {student2['Ø§Ù„Ø¥Ø³Ù…']}" if student2 else ""
        
        email_body = f"""<html dir="rtl"><body>
        <h2>âœ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <p>Ø§Ù„Ø£Ø³ØªØ§Ø°(Ø©) {prof_name}ØŒ</p>
        <p>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©:</p>
        <p>ğŸ“„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©: {memo_info['Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©']}</p>
        <p>ğŸ“‘ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {memo_info['Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø°ÙƒØ±Ø©']}</p>
        <p>ğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„: {student1['Ø§Ù„Ù„Ù‚Ø¨']} {student1['Ø§Ù„Ø¥Ø³Ù…']}{student2_info}</p>
        <p>ğŸ“Š Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: {registered} Ù…Ù† {total}</p>
        </body></html>"""
        
        msg = MIMEMultipart('alternative')
        msg['From'] = EMAIL_SENDER
        msg['To'] = prof_email
        msg['Subject'] = f"âœ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© - {memo_info['Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©']}"
        msg.attach(MIMEText(email_body, 'html', 'utf-8'))
        
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
            server.starttls()
            server.login(EMAIL_SENDER, EMAIL_PASSWORD)
            server.send_message(msg)
        
        return True, "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯"
    except Exception as e:
        return False, f"ÙØ´Ù„: {e}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 9. Ø§Ù„ØªØ­Ù‚Ù‚ - VERIFICATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def verify_student(username, password, df_students):
    valid, result = validate_username(username)
    if not valid:
        return False, result
    username = result
    password = sanitize_input(password)
    if df_students.empty:
        return False, "âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
    student = df_students[df_students["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"].astype(str).str.strip() == username]
    if student.empty:
        return False, "âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
    if student.iloc[0]["ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"].strip() != password:
        return False, "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"
    return True, student.iloc[0]

def verify_students_batch(students_data, df_students):
    verified = []
    for username, password in students_data:
        if not username:
            continue
        valid, student = verify_student(username, password, df_students)
        if not valid:
            return False, student
        verified.append(student)
    return True, verified

def verify_professor(username, password, df_prof_memos):
    valid, result = validate_username(username)
    if not valid:
        return False, result
    username = result
    password = sanitize_input(password)
    if df_prof_memos.empty:
        return False, "âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
    prof = df_prof_memos[
        (df_prof_memos["Ø¥Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"].astype(str).str.strip() == username) &
        (df_prof_memos["ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"].astype(str).str.strip() == password)
    ]
    if prof.empty:
        return False, "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©"
    return True, prof.iloc[0]

def verify_admin(username, password):
    username = sanitize_input(username)
    password = sanitize_input(password)
    if username == ADMIN_USERNAME and password == ADMIN_PASSWORD:
        return True, None
    return False, "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø®Ø§Ø·Ø¦Ø©"

def verify_professor_password(note_number, prof_password, df_memos, df_prof_memos):
    valid, result = validate_note_number(note_number)
    if not valid:
        return False, None, result
    note_number = result
    prof_password = sanitize_input(prof_password)
    if df_memos.empty or df_prof_memos.empty:
        return False, None, "âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
    memo_row = df_memos[df_memos["Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©"].astype(str).str.strip() == note_number]
    if memo_row.empty:
        return False, None, "âŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
    memo_row = memo_row.iloc[0]
    if str(memo_row.get("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "")).strip() == MEMO_REGISTERED:
        return False, None, "âŒ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹"
    prof_row = df_prof_memos[
        (df_prof_memos["Ø§Ù„Ø£Ø³ØªØ§Ø°"].astype(str).str.strip() == memo_row["Ø§Ù„Ø£Ø³ØªØ§Ø°"].strip()) &
        (df_prof_memos["ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„"].astype(str).str.strip() == prof_password)
    ]
    if prof_row.empty:
        return False, None, "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"
    if str(prof_row.iloc[0].get("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "")).strip() == MEMO_REGISTERED:
        return False, None, "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø³ØªØ®Ø¯Ù…Ø©"
    return True, prof_row.iloc[0], None

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 10. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - DATA UPDATE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def update_registration(note_number, student1, student2=None):
    try:
        df_memos = load_memos()
        df_prof_memos = load_prof_memos()
        df_students = load_students()

        prof_name = df_memos[df_memos["Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©"].astype(str).str.strip() == str(note_number).strip()]["Ø§Ù„Ø£Ø³ØªØ§Ø°"].iloc[0].strip()
        used_prof_password = st.session_state.prof_password.strip()
        
        prof_row_idx = df_prof_memos[
            (df_prof_memos["Ø§Ù„Ø£Ø³ØªØ§Ø°"].astype(str).str.strip() == prof_name) &
            (df_prof_memos["ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„"].astype(str).str.strip() == used_prof_password)
        ].index[0] + 2

        col_names = df_prof_memos.columns.tolist()
        updates = [
            {"range": f"Feuille 1!{col_letter(col_names.index('Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„')+1)}{prof_row_idx}",
             "values": [[student1['Ø§Ù„Ù„Ù‚Ø¨'] + ' ' + student1['Ø§Ù„Ø¥Ø³Ù…']]]},
            {"range": f"Feuille 1!{col_letter(col_names.index('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„')+1)}{prof_row_idx}",
             "values": [[MEMO_REGISTERED]]},
            {"range": f"Feuille 1!{col_letter(col_names.index('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„')+1)}{prof_row_idx}",
             "values": [[datetime.now().strftime('%Y-%m-%d %H:%M')]]},
            {"range": f"Feuille 1!{col_letter(col_names.index('Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©')+1)}{prof_row_idx}",
             "values": [[note_number]]}
        ]
        
        if student2:
            updates.append({"range": f"Feuille 1!{col_letter(col_names.index('Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ')+1)}{prof_row_idx}",
                          "values": [[student2['Ø§Ù„Ù„Ù‚Ø¨'] + ' ' + student2['Ø§Ù„Ø¥Ø³Ù…']]]})
        
        sheets_service.spreadsheets().values().batchUpdate(
            spreadsheetId=PROF_MEMOS_SHEET_ID,
            body={"valueInputOption": "USER_ENTERED", "data": updates}
        ).execute()

        memo_row_idx = df_memos[df_memos["Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©"].astype(str).str.strip() == str(note_number).strip()].index[0] + 2
        memo_cols = df_memos.columns.tolist()
        updates2 = [
            {"range": f"Feuille 1!{col_letter(memo_cols.index('Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„')+1)}{memo_row_idx}",
             "values": [[student1['Ø§Ù„Ù„Ù‚Ø¨'] + ' ' + student1['Ø§Ù„Ø¥Ø³Ù…']]]},
            {"range": f"Feuille 1!{col_letter(memo_cols.index('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„')+1)}{memo_row_idx}",
             "values": [[MEMO_REGISTERED]]},
            {"range": f"Feuille 1!{col_letter(memo_cols.index('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„')+1)}{memo_row_idx}",
             "values": [[datetime.now().strftime('%Y-%m-%d %H:%M')]]}
        ]
        
        if 'ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„' in memo_cols:
            updates2.append({"range": f"Feuille 1!{col_letter(memo_cols.index('ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„')+1)}{memo_row_idx}",
                           "values": [[used_prof_password]]})
        
        if student2:
            updates2.append({"range": f"Feuille 1!{col_letter(memo_cols.index('Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ')+1)}{memo_row_idx}",
                           "values": [[student2['Ø§Ù„Ù„Ù‚Ø¨'] + ' ' + student2['Ø§Ù„Ø¥Ø³Ù…']]]})
        
        sheets_service.spreadsheets().values().batchUpdate(
            spreadsheetId=MEMOS_SHEET_ID,
            body={"valueInputOption": "USER_ENTERED", "data": updates2}
        ).execute()

        students_cols = df_students.columns.tolist()
        student1_row_idx = df_students[df_students["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"].astype(str).str.strip() == student1['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'].strip()].index[0] + 2
        sheets_service.spreadsheets().values().update(
            spreadsheetId=STUDENTS_SHEET_ID,
            range=f"Feuille 1!{col_letter(students_cols.index('Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©')+1)}{student1_row_idx}",
            valueInputOption="USER_ENTERED",
            body={"values": [[note_number]]}
        ).execute()

        if student2:
            student2_row_idx = df_students[df_students["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"].astype(str).str.strip() == student2['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'].strip()].index[0] + 2
            sheets_service.spreadsheets().values().update(
                spreadsheetId=STUDENTS_SHEET_ID,
                range=f"Feuille 1!{col_letter(students_cols.index('Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©')+1)}{student2_row_idx}",
                valueInputOption="USER_ENTERED",
                body={"values": [[note_number]]}
            ).execute()

        time.sleep(2)
        clear_cache_and_reload()
        time.sleep(1)
        
        df_students_updated = load_students()
        st.session_state.student1 = df_students_updated[
            df_students_updated["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"].astype(str).str.strip() == student1['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'].strip()
        ].iloc[0]
        
        if student2:
            st.session_state.student2 = df_students_updated[
                df_students_updated["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"].astype(str).str.strip() == student2['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'].strip()
            ].iloc[0]

        memo_data = df_memos[df_memos["Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©"].astype(str).str.strip() == str(note_number).strip()].iloc[0]
        prof_memo_data = df_prof_memos[(df_prof_memos["Ø§Ù„Ø£Ø³ØªØ§Ø°"].astype(str).str.strip() == prof_name)].iloc[0]
        prof_email = str(prof_memo_data.get("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", "")).strip()
        
        if prof_email and "@" in prof_email:
            send_email_to_professor(prof_email, prof_name, memo_data, student1, student2)
        
        return True, "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!"
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ Ø§Ù„ØªØ­Ø¯ÙŠØ«: {e}")
        return False, f"âŒ Ø®Ø·Ø£: {e}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 11. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© - SESSION MANAGEMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def initialize_session_state():
    defaults = {
        'logged_in': False, 'user_type': None, 'student1': None, 'student2': None,
        'professor_data': None, 'memo_type': "ÙØ±Ø¯ÙŠØ©", 'mode': "register",
        'note_number': "", 'prof_password': "", 'show_confirmation': False
    }
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

def logout():
    st.session_state.clear()
    initialize_session_state()
    st.rerun()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 12. ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - USER INTERFACES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def show_header():
    st.markdown("<h5 style='text-align:center;'>Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø´ÙŠØ± Ø§Ù„Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠ</h5>", unsafe_allow_html=True)
    st.markdown("<h6 style='text-align:center;'>ÙƒÙ„ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ©</h6>", unsafe_allow_html=True)
    st.markdown("<div style='text-align:center; margin:20px 0;'><img src='https://raw.githubusercontent.com/SAMIR-MALEK/memoire-depot-2026/main/LOGO2.png' width='100'></div>", unsafe_allow_html=True)
    st.markdown("<h4 style='text-align:center; color:#FFD700;'>Ù…Ù†ØµØ© ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ù…Ø§Ø³ØªØ±</h4>", unsafe_allow_html=True)

def show_login_selection():
    st.markdown('<div class="block-container">', unsafe_allow_html=True)
    show_header()
    st.markdown("---")
    st.markdown("### ğŸ” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø®ÙˆÙ„")
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨", use_container_width=True):
            st.session_state.user_type = USER_TYPE_STUDENT
            st.rerun()
    with col2:
        if st.button("ğŸ‘¨â€ğŸ« Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©", use_container_width=True):
            st.session_state.user_type = USER_TYPE_PROFESSOR
            st.rerun()
    with col3:
        if st.button("ğŸ‘” Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", use_container_width=True):
            st.session_state.user_type = USER_TYPE_ADMIN
            st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

def show_student_login(df_students):
    st.markdown('<div class="block-container">', unsafe_allow_html=True)
    show_header()
    if st.button("â¬…ï¸ Ø±Ø¬ÙˆØ¹"):
        st.session_state.user_type = None
        st.rerun()
    st.markdown("### ğŸ‘¨â€ğŸ“ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨")
    st.session_state.memo_type = st.radio("Ù†ÙˆØ¹ Ø§Ù„Ù…Ø°ÙƒØ±Ø©:", ["ÙØ±Ø¯ÙŠØ©", "Ø«Ù†Ø§Ø¦ÙŠØ©"])
    username1 = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆÙ„", max_chars=50)
    password1 = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø£ÙˆÙ„", type="password", max_chars=50)
    username2 = password2 = None
    if st.session_state.memo_type == "Ø«Ù†Ø§Ø¦ÙŠØ©":
        username2 = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ", max_chars=50)
        password2 = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ", type="password", max_chars=50)
    if st.button("Ø¯Ø®ÙˆÙ„", type="primary"):
        if st.session_state.memo_type == "Ø«Ù†Ø§Ø¦ÙŠØ©" and (not username2 or not password2):
            st.markdown('<div class="error-msg">âš ï¸ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠ</div>', unsafe_allow_html=True)
            st.stop()
        if st.session_state.memo_type == "Ø«Ù†Ø§Ø¦ÙŠØ©" and username1.strip().lower() == username2.strip().lower():
            st.markdown('<div class="error-msg">âŒ Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ!</div>', unsafe_allow_html=True)
            st.stop()
        students_data = [(username1, password1)]
        if st.session_state.memo_type == "Ø«Ù†Ø§Ø¦ÙŠØ©" and username2:
            students_data.append((username2, password2))
        valid, result = verify_students_batch(students_data, df_students)
        if not valid:
            st.markdown(f'<div class="error-msg">{result}</div>', unsafe_allow_html=True)
        else:
            verified = result
            st.session_state.student1 = verified[0]
            st.session_state.student2 = verified[1] if len(verified) > 1 else None
            if st.session_state.memo_type == "Ø«Ù†Ø§Ø¦ÙŠØ©" and st.session_state.student2:
                s1_note = str(st.session_state.student1.get('Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©', '')).strip()
                s2_note = str(st.session_state.student2.get('Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©', '')).strip()
                s1_spec = str(st.session_state.student1.get('Ø§Ù„ØªØ®ØµØµ', '')).strip()
                s2_spec = str(st.session_state.student2.get('Ø§Ù„ØªØ®ØµØµ', '')).strip()
                if s1_spec != s2_spec:
                    st.markdown('<div class="error-msg">âŒ ØªØ®ØµØµØ§Øª Ù…Ø®ØªÙ„ÙØ©</div>', unsafe_allow_html=True)
                    st.stop()
                if (s1_note and not s2_note) or (not s1_note and s2_note):
                    st.markdown('<div class="error-msg">âŒ Ø£Ø­Ø¯Ù‡Ù…Ø§ Ù…Ø³Ø¬Ù„</div>', unsafe_allow_html=True)
                    st.stop()
                if s1_note and s2_note and s1_note != s2_note:
                    st.markdown('<div class="error-msg">âŒ Ù…Ø°ÙƒØ±ØªØ§Ù† Ù…Ø®ØªÙ„ÙØªØ§Ù†</div>', unsafe_allow_html=True)
                    st.stop()
                if s1_note and s2_note:
                    st.session_state.mode = "view"
            if st.session_state.memo_type == "ÙØ±Ø¯ÙŠØ©":
                fardiya = str(st.session_state.student1.get('ÙØ±Ø¯ÙŠØ©', '')).strip()
                if fardiya not in ["1", "Ù†Ø¹Ù…"]:
                    st.markdown('<div class="error-msg">âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙØ±Ø¯ÙŠ</div>', unsafe_allow_html=True)
                    st.stop()
            note = str(st.session_state.student1.get('Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©', '')).strip()
            st.session_state.mode = "view" if note else "register"
            st.session_state.logged_in = True
            st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

def show_professor_login(df_prof_memos):
    st.markdown('<div class="block-container">', unsafe_allow_html=True)
    show_header()
    if st.button("â¬…ï¸ Ø±Ø¬ÙˆØ¹"):
        st.session_state.user_type = None
        st.rerun()
    st.markdown("### ğŸ‘¨â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©")
    username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", max_chars=50)
    password = st.text_input("ÙƒÙ„Ù…
